# AGENTS.md — Контекст для AI-ассистентов

Этот файл содержит важную информацию о проекте, архитектурных решениях, правилах кодирования и уроках, извлеченных в
процессе разработки. Используйте этот контекст перед началом работы над задачами.

## 1. Обзор проекта
**Student Assistant** — Android-приложение для студентов и школьников.
* **Стек:** Kotlin, Jetpack Compose (Material 3), Room, Dagger 2, Coroutines & Flow.
* **Сборка:** Gradle Kotlin DSL, Version Catalogs (`libs.versions.toml`).
* **Архитектура:** Многомодульная (`app`, `features/*`, `core/*`, `common/*`).

## 2. Терминология
* **Lesson**: В коде и комментариях переводить как **"Занятие"**, а не "Урок". Это универсальный термин для школы и
  вуза.
* **Semester**: Семестр или четверть.
* **Homework**: Домашнее задание.

## 3. Архитектура и Ключевые Решения

### База Данных (Room)
* **Room** является единственным источником истины.
* **Сложные запросы:** В `LessonDao` используется сложный SQL-запрос с `UNION` для объединения регулярных занятий (по
  дням недели) и разовых занятий (по датам).
* **Хранение недель:** Повторение по неделям хранится как строка из '0' и '1' (например, "101" — 1-я и 3-я недели). В
  SQL это обрабатывается через функцию `substr`.
    * **Важно:** Не переносите логику фильтрации недель или дат из SQL в Kotlin (`filter` в памяти). Текущая реализация
      оптимизирована для производительности.

### Навигация (Navigation 3)
* Используется библиотека `androidx.navigation3`.
* Реализована собственная обертка в модуле `:common:navigation`:
    * `NavigationState` — хранит состояние бэкстека.
    * `Navigator` — управляет переходами.
* Маршруты (`Routes`) объявляются как `Serializable` sealed интерфейсы/классы (например, `ScheduleRoute`,
  `HomeworksRoute`) внутри `api` подмодулей фич.

### Dependency Injection (Dagger 2)
* Используется классический Dagger 2 (не Hilt).
* **Component Holder Pattern:** Каждый feature-модуль имеет свой `ComponentHolder` (синглтон), который хранит экземпляр
  компонента.
* **Assisted Injection:** Активно используется для создания ViewModel с параметрами (например, `id` урока),
  передаваемыми через навигацию.

### UI (Jetpack Compose)
* Полностью на **Material 3**.
* Используется кастомная система отступов через `LocalDimensions` (файл `Dimensions.kt` в `:core:style`).
    * **Правило:** Используйте `MaterialTheme.dimensions` только для стандартных отступов (экраны, карточки), уже
      определенных в `Dimensions`. Для специфических отступов внутри компонентов используйте хардкод значений в `dp`.

## 4. Правила написания кода
* **Модификаторы доступа:** По умолчанию используйте `internal`. `public` только для классов/интерфейсов в `api` модулях
  или для DI провайдеров.
* **Flow:** Используйте `StateFlow` в ViewModel для UI-состояния. При использовании оператора `stateIn` всегда
  указывайте `SharingStarted.Default` (extension-свойство из пакета `ru.erdenian.studentassistant.utils`), которое
  задает `stopTimeoutMillis = 5_000L` для корректной обработки смены конфигурации.
* **Строки:** Все строки должны быть вынесены в модуль `:core:strings`.
* **Code Style:** Проект использует `detekt`. Конфигурация лежит в `detekt-config.yml`. Перед коммитом запускайте
  `detektMain`.
* **Документация:** При выяснении новых подробностей о написании кода нужно также обновлять AGENTS.md и README.md.
  На неочевидные моменты нужно добавлять комментарии в код. Вся документация и комментарии должны быть на русском языке,
  старые комментарии на английском языке при изменении файла нужно переводить на русский.

## 5. Тестирование
* **Покрытие кода (Coverage):** Мы стремимся к **100% покрытию кода** тестами.
* **Актуализация:** При любом изменении функциональности соответствующие тесты **должны быть обновлены**.
* **Работа с непокрытым кодом:** Если вы вносите изменения в участок кода, который ранее не был протестирован, вы
  **обязаны** написать тесты для этого участка. Нельзя модифицировать логику, оставляя её без тестов.
* **Unit-тесты (test):** Основной приоритет. Используются `Fake`-реализации репозиториев и DAO (`FakeLessonDao`,
  `FakeSemesterDao`), находящиеся в `features/repository/src/test/.../Fakes.kt`.
    * **Правило для Fakes:** Они должны имитировать поведение SQL, включая сортировку (`sortedWith`) и автогенерацию ID.
* **Android-тесты (androidTest):** Используются в основном для проверки корректности SQL-запросов в Room (особенно
  логика битовых масок недель и дат).
* **Запрещено:** Использовать `LocalDate.now()` и другие функции, зависящие от внешнего состояния, в тестах без явной
  подмены (моков/фикстур).

## 6. Git и Коммиты
* Сообщения коммитов должны быть на **русском языке**.
* Пишите понятные и лаконичные описания изменений.

## 7. Ведение CHANGELOG.md
Все изменения, влияющие на пользователя или поведение приложения, должны быть отражены в `CHANGELOG.md` в секции
`[Unreleased]`.

**Обязательный порядок секций:**
1. `Fixed`: Исправления багов.
2. `Added`: Новые функции.
3. `Changed`: Изменения в существующем функционале.
4. `Removed`: Удаленные функции.

Другие типы секций (например, `Deprecated` или `Security`) не используются.

**Что НЕ нужно записывать:**
* Изменения сборки, обновление зависимостей (если это не влияет на пользователя).
* Рефакторинг без изменения поведения.
* Исправление стиля кода.

## 8. Известные особенности
* **Проблемы с производительностью:** Логика получения занятий на конкретный день была оптимизирована через SQL. Любые
  изменения в `LessonDao.getAllFlow` требуют тщательного профилирования.
* **Удаление сущностей:** При удалении занятия, для которого есть домашние задания, пользователю предлагается выбор (
  удалить или оставить задания). Эта логика реализована во ViewModels.
